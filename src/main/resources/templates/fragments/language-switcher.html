<!-- 语言切换组件 -->
<div class="language-switcher flex items-center space-x-1 border-b border-gray-200" th:fragment="language-switcher">
    <!-- 中文按钮 -->
    <button type="button" 
            class="language-btn px-4 py-2 text-base font-medium transition-all duration-300 cursor-pointer relative"
            th:classappend="${language == 'zh' or language == null} ? 'text-primary font-semibold lang-btn-active' : 'text-gray-600 hover:text-gray-900'"
            th:text="'中文'"
            onclick="switchLanguage('zh')">中文</button>
    
    <!-- 分隔符 -->
    <span class="text-gray-300 select-none">|</span>
    
    <!-- 英文按钮 -->
    <button type="button" 
            class="language-btn px-4 py-2 text-base font-medium transition-all duration-300 cursor-pointer relative"
            th:classappend="${language != null and language == 'en'} ? 'text-primary font-semibold lang-btn-active' : 'text-gray-600 hover:text-gray-900'"
            th:text="'English'"
            onclick="switchLanguage('en')">English</button>
</div>

<!-- 语言切换按钮样式 -->
<style>
    .language-switcher {
        display: inline-flex;
        background: transparent;
        padding-bottom: 0;
        border-bottom: none;
    }
    
    .language-btn {
        background: none;
        border: none;
        position: relative;
    }
    
    .language-btn::after {
        content: '';
        position: absolute;
        left: 50%;
        bottom: -2px;
        transform: translateX(-50%) scaleX(0);
        width: 80%;
        height: 2px;
        background-color: var(--color-primary);
        transition: transform 0.3s ease;
    }
    
    .language-btn.lang-btn-active::after {
        transform: translateX(-50%) scaleX(1);
    }
    
    .language-btn:not(.lang-btn-active):hover::after {
        transform: translateX(-50%) scaleX(0.5);
        opacity: 0.5;
    }
</style>

<!-- JavaScript 语言切换功能 -->
<script th:fragment="language-switcher-script">
    // 语言状态管理
    const LanguageManager = {
        // 从localStorage获取语言设置
        getStoredLanguage: function() {
            try {
                return localStorage.getItem('philosophy_language') || this.getCookieLanguage() || 'zh';
            } catch (e) {
                console.warn('无法访问localStorage，尝试从Cookie获取');
                return this.getCookieLanguage() || 'zh';
            }
        },
        
        // 从Cookie获取语言设置
        getCookieLanguage: function() {
            try {
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    const [name, value] = cookie.trim().split('=');
                    if (name === 'philosophy_language') {
                        return value;
                    }
                }
            } catch (e) {
                console.warn('无法读取Cookie:', e);
            }
            return null;
        },
        
        // 保存语言设置到localStorage
        setStoredLanguage: function(lang) {
            try {
                localStorage.setItem('philosophy_language', lang);
                console.log('语言设置已保存到localStorage:', lang);
            } catch (e) {
                console.warn('无法保存到localStorage:', e);
            }
        },
        
        // 同步服务器和本地语言设置
        syncLanguage: function() {
            const storedLang = this.getStoredLanguage();
            const currentLang = this.getCurrentLanguageFromPage();
            
            console.log('本地存储语言:', storedLang, '页面当前语言:', currentLang);
            
            // 如果本地存储的语言与页面当前语言不同，同步到服务器
            if (storedLang !== currentLang) {
                console.log('检测到语言不一致，同步到服务器:', storedLang);
                this.updateServerLanguage(storedLang);
            }
        },
        
        // 从页面获取当前语言
        getCurrentLanguageFromPage: function() {
            const activeButton = document.querySelector('.language-btn.bg-primary');
            if (activeButton) {
                return activeButton.textContent.trim() === '中文' ? 'zh' : 'en';
            }
            return 'zh';
        },
        
        // 更新服务器语言设置
        updateServerLanguage: function(lang) {
            fetch('/language/set?lang=' + lang)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('服务器语言设置已同步:', lang);
                    }
                })
                .catch(error => {
                    console.warn('同步服务器语言设置失败:', error);
                });
        }
    };

    // 语言切换功能
    function switchLanguage(lang) {
        console.log('切换语言到:', lang);
        
        // 立即保存到localStorage
        LanguageManager.setStoredLanguage(lang);
        
        // 显示加载状态
        const buttons = document.querySelectorAll('.language-btn');
        buttons.forEach(btn => {
            btn.disabled = true;
            btn.style.opacity = '0.6';
        });
        
        // 使用AJAX切换语言
        fetch('/language/set?lang=' + lang)
            .then(response => {
                if (!response.ok) {
                    throw new Error('网络请求失败: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                console.log('语言切换响应:', data);
                if (data.success) {
                    // 显示成功提示
                    showLanguageNotification(lang);
                    // 重新加载页面以应用新语言
                    setTimeout(() => {
                        window.location.reload();
                    }, 500);
                } else {
                    console.error('语言切换失败:', data.message);
                    showErrorNotification('语言切换失败: ' + data.message);
                    // 恢复按钮状态
                    restoreButtons();
                }
            })
            .catch(error => {
                console.error('语言切换错误:', error);
                // 如果AJAX失败，使用传统方式
                console.log('使用传统方式切换语言');
                window.location.href = '/language/switch?lang=' + lang;
            });
    }
    
    // 显示语言切换通知
    function showLanguageNotification(lang) {
        const notification = document.createElement('div');
        notification.className = 'fixed top-1/4 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-green-500 text-white px-8 py-4 rounded-full shadow-2xl z-50 transition-all duration-300 text-lg font-medium';
        notification.textContent = lang === 'en' ? 'Switched to English' : '已切换到中文';
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.opacity = '0';
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 300);
        }, 2000);
    }
    
    // 显示错误通知
    function showErrorNotification(message) {
        const notification = document.createElement('div');
        notification.className = 'fixed top-1/4 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-red-500 text-white px-8 py-4 rounded-full shadow-2xl z-50 transition-all duration-300 text-lg font-medium';
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.opacity = '0';
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 300);
        }, 3000);
    }
    
    // 恢复按钮状态
    function restoreButtons() {
        const buttons = document.querySelectorAll('.language-btn');
        buttons.forEach(btn => {
            btn.disabled = false;
            btn.style.opacity = '1';
        });
    }
    
    // 获取当前语言
    function getCurrentLanguage() {
        return fetch('/language/current')
            .then(response => response.json())
            .then(data => data.language)
            .catch(error => {
                console.error('获取当前语言失败:', error);
                return 'zh'; // 默认中文
            });
    }
    
    // 页面加载时初始化语言状态
    document.addEventListener('DOMContentLoaded', function() {
        // 只记录当前语言，不自动切换
        const currentLang = LanguageManager.getCurrentLanguageFromPage();
        console.log('页面加载 - 当前语言:', currentLang);
        
        // 获取当前语言并记录
        getCurrentLanguage().then(lang => {
            console.log('服务器当前语言:', lang);
        });
    });
</script>
