<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/header :: head}" th:with="pageTitle=${pageTitle} + ' - 哲学'">
    
    <!-- 自定义工具类 -->
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .text-shadow {
                text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            .transition-smooth {
                transition: all 0.3s ease-in-out;
            }
            .hover-scale-105:hover {
                transform: scale(1.05);
            }
            .hover-scale-110:hover {
                transform: scale(1.1);
            }
            .group-hover-scale-105:hover {
                transform: scale(1.05);
            }
            .group-hover-scale-110:hover {
                transform: scale(1.1);
            }
            .bg-blur {
                backdrop-filter: blur(8px);
            }
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(12px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up { animation: fadeInUp 0.4s ease-out both; }
    </style>
    <link rel="stylesheet" th:href="@{/css/theme.css}">
</head>
<body class="bg-secondary min-h-screen flex flex-col">
    <!-- 导航栏 -->
    <header id="navbar" class="fixed top-0 left-0 right-0 z-50 transition-all duration-300 bg-white shadow-md">
        <div class="container mx-auto px-4 py-5 flex justify justify-between items-center">
            <a href="/" id="logo" class="text-2xl font-bold text-primary transition-colors duration-300">哲学</a>
            <div class="flex items-center space-x-4">
                <nav class="hidden md:flex space-x-8">
                    <a href="/philosophers" class="nav-link" th:classappend="${activePage == 'philosophers'} ? 'active'" data-page="philosophers">哲学</a>
                    <a href="/schools" class="nav-link" th:classappend="${activePage == 'schools'} ? 'active'" data-page="schools">流派</a>
                    <th:block th:if="${isAuthenticated}">
                        <a href="/logout" class="nav-link" data-page="logout">
                            <span th:text="${language != null and language == 'en'} ? 'Logout' : '退出'">退出</span>
                        </a>
                    </th:block>
                    <th:block th:unless="${isAuthenticated}">
                        <a href="/login" class="nav-link" th:classappend="${activePage == 'login'} ? 'active'" data-page="login">
                            <span th:text="${language != null and language == 'en'} ? 'Login' : '登录'">登录</span>
                        </a>
                    </th:block>
                </nav>
                <button id="menu-toggle" class="md:hidden text-primary text-xl">
                    <i class="fa fa-bars"></i>
                </button>
            </div>
        </div>
        <div id="mobile-menu" class="hidden md:hidden bg-white bg-opacity-95 bg-blur shadow-lg absolute w-full">
            <div class="container mx-auto px-4 py-4 flex flex-col space-y-4">
                <a href="/philosophers" class="mobile-nav-link py-2 border-b border-gray-100" th:classappend="${activePage == 'philosophers'} ? 'active'" data-page="philosophers">哲学</a>
                <a href="/schools" class="mobile-nav-link py-2 border-b border-gray-100" th:classappend="${activePage == 'schools'} ? 'active'" data-page="schools">流派</a>
                <th:block th:unless="${isAuthenticated}">
                    <a href="/login" class="mobile-nav-link py-2 text-primary" th:classappend="${activePage == 'login'} ? 'active'">
                        <i class="fa fa-sign-in"></i>
                        <span th:text="${language != null and language == 'en'} ? 'Login/Register' : '登录/注册'">登录/注册</span>
                    </a>
                </th:block>
                <th:block th:if="${isAuthenticated}">
                    <a href="/logout" class="mobile-nav-link py-2 text-primary">
                        <i class="fa fa-sign-out"></i>
                        <span th:text="${language != null and language == 'en'} ? 'Logout' : '退出'">退出</span>
                    </a>
                    <th:block th:if="${isAdmin}">
                        <a href="/admin" class="mobile-nav-link py-2 text-primary">
                            <i class="fa fa-cog"></i> 管理
                        </a>
                    </th:block>
                </th:block>
            </div>
        </div>
    </header>

    <!-- 主要内容 -->
    <main class="flex-grow container mx-auto px-4 py-8" style="padding-top: calc(5rem + 2rem);">
        <!-- 页面内容将在这里插入 -->
        <div th:fragment="content">
            <!-- 默认内容 -->
        </div>
    </main>

    <footer class="bg-primary text-white py-8">
        <div class="container mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-4 md:mb-0">
                    <h3 class="text-2xl font-bold mb-1">哲学</h3>
                    <p class="text-gray-300 text-sm">我的学习笔记</p>
                </div>
                <div class="flex items-center space-x-4">
                    <!-- 搜索按钮 -->
                    <button id="search-toggle" 
                            class="flex items-center justify-center w-14 h-14 bg-white/10 hover:bg-white/20 rounded-full transition-all duration-300 hover:scale-105"
                            onclick="openSearchModal()"
                            title="搜索">
                        <i class="fa fa-search text-2xl"></i>
                    </button>
                </div>
            </div>
        </div>
    </footer>

    <!-- 搜索模态框 -->
    <div id="search-modal" class="fixed inset-0 z-50 hidden">
        <!-- 半透明背景遮罩层 - 使用主题颜色 -->
        <div class="absolute inset-0" style="background: color-mix(in srgb, var(--color-primary) 50%, transparent); backdrop-filter: blur(4px);"></div>
        
        <!-- 搜索面板 - 从底部弹出 -->
        <div class="fixed bottom-0 left-1/2 transform -translate-x-1/2 w-2/3 bg-primary rounded-t-2xl shadow-2xl transition-transform duration-300 translate-y-full relative z-10" id="search-panel">
            <div class="p-6">
                <!-- 搜索头部 -->
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-semibold text-gray-800">搜索</h3>
                    <button onclick="closeSearchModal()" class="text-gray-500 hover:text-gray-700 transition-colors">
                        <i class="fa fa-times text-xl"></i>
                    </button>
                </div>
                
                <!-- 搜索输入框 -->
                <div class="relative mb-4">
                    <input type="text" 
                           id="search-input" 
                           placeholder="输入关键词搜索..."
                           class="w-full px-4 py-3 pr-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none text-lg"
                           onkeypress="handleSearchKeypress(event)">
                    <button onclick="performSearch()" 
                            class="absolute right-2 top-1/2 transform -translate-y-1/2 bg-primary text-white px-4 py-2 rounded-md hover:bg-primary-dark transition-colors">
                        <i class="fa fa-search"></i>
                    </button>
                </div>
                
                
                <!-- 搜索结果 -->
                <div id="search-results" class="hidden">
                    <div class="text-sm text-gray-600 mb-2">搜索结果：</div>
                    <div id="search-results-content" class="space-y-2">
                        <!-- 搜索结果将在这里动态加载 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 移动端菜单切换
        document.getElementById('menu-toggle').addEventListener('click', function() {
            const mobileMenu = document.getElementById('mobile-menu');
            mobileMenu.classList.toggle('hidden');
        });

        // 语言切换功能
        function toggleLanguage() {
            // 获取当前语言
            getCurrentLanguage().then(currentLang => {
                const newLang = currentLang === 'zh' ? 'en' : 'zh';
                
                // 显示加载状态
                const langButton = document.getElementById('lang-toggle');
                if (langButton) {
                    langButton.disabled = true;
                    langButton.style.opacity = '0.6';
                }
                
                // 使用AJAX切换语言
                fetch('/language/set?lang=' + newLang)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('网络请求失败: ' + response.status);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('语言切换响应:', data);
                        if (data.success) {
                            // 显示成功提示
                            showLanguageToggleNotification(newLang);
                            // 重新加载页面以应用新语言
                            setTimeout(() => {
                                window.location.reload();
                            }, 500);
                        } else {
                            console.error('语言切换失败:', data.message);
                            showErrorNotification('语言切换失败: ' + data.message);
                            // 恢复按钮状态
                            restoreLanguageButton();
                        }
                    })
                    .catch(error => {
                        console.error('语言切换错误:', error);
                        // 如果AJAX失败，使用传统方式
                        console.log('使用传统方式切换语言');
                        window.location.href = '/language/switch?lang=' + newLang;
                    });
            });
        }

        // 获取当前语言
        function getCurrentLanguage() {
            return fetch('/language/current')
                .then(response => response.json())
                .then(data => data.language)
                .catch(error => {
                    console.error('获取当前语言失败:', error);
                    return 'zh'; // 默认中文
                });
        }

        // 恢复语言按钮状态
        function restoreLanguageButton() {
            const langButton = document.getElementById('lang-toggle');
            if (langButton) {
                langButton.disabled = false;
                langButton.style.opacity = '1';
            }
        }

        // 显示错误通知
        function showErrorNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // 更新语言按钮文本（现在只更新title属性）
        function updateLanguageButtonText(lang) {
            const langButton = document.getElementById('lang-toggle');
            if (langButton) {
                langButton.title = lang === 'en' ? 'Switch to Chinese' : '切换语言';
            }
        }

        // 显示语言切换通知
        function showLanguageToggleNotification(lang) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 bg-primary text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300';
            notification.textContent = lang === 'en' ? 'Switched to English' : '已切换到中文';
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 2000);
        }

        // 页面加载时检查语言设置
        function checkLanguageSetting() {
            getCurrentLanguage().then(lang => {
                console.log('当前语言:', lang);
                updateLanguageButtonText(lang);
                if (lang === 'en') {
                    // 如果设置为英文，可以在这里添加英文版本的逻辑
                    console.log('Language set to English');
                }
            });
        }

        // 页面加载时的初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('页面加载完成');
            checkLanguageSetting();
        });

        // 搜索功能管理
        const SearchManager = {
            isOpen: false,
            
            // 打开搜索面板
            open: function() {
                const modal = document.getElementById('search-modal');
                const panel = document.getElementById('search-panel');
                
                if (modal && panel) {
                    modal.classList.remove('hidden');
                    // 延迟显示动画，确保DOM已更新
                    setTimeout(() => {
                        panel.classList.remove('translate-y-full');
                    }, 10);
                    
                    // 聚焦到输入框
                    setTimeout(() => {
                        const input = document.getElementById('search-input');
                        if (input) {
                            input.focus();
                        }
                    }, 300);
                    
                    this.isOpen = true;
                    this.showSuggestions();
                }
            },
            
            // 关闭搜索面板
            close: function() {
                const modal = document.getElementById('search-modal');
                const panel = document.getElementById('search-panel');
                
                if (modal && panel) {
                    panel.classList.add('translate-y-full');
                    setTimeout(() => {
                        modal.classList.add('hidden');
                    }, 300);
                    
                    this.isOpen = false;
                    this.clearResults();
                }
            },
            
            // 显示搜索建议
            showSuggestions: function() {
                const suggestions = document.getElementById('search-suggestions');
                if (suggestions) {
                    suggestions.classList.remove('hidden');
                }
            },
            
            // 隐藏搜索建议
            hideSuggestions: function() {
                const suggestions = document.getElementById('search-suggestions');
                if (suggestions) {
                    suggestions.classList.add('hidden');
                }
            },
            
            // 显示搜索结果
            showResults: function(results) {
                const resultsDiv = document.getElementById('search-results');
                const contentDiv = document.getElementById('search-results-content');
                
                if (resultsDiv && contentDiv) {
                    this.hideSuggestions();
                    
                    if (results && results.length > 0) {
                        contentDiv.innerHTML = results.map(result => `
                            <div class="p-3 bg-gray-50 rounded-lg hover:bg-gray-100 cursor-pointer transition-colors" onclick="openSearchResult('${result.url}')">
                                <div class="font-medium text-gray-800">${result.title}</div>
                                <div class="text-sm text-gray-600 mt-1">${result.description}</div>
                            </div>
                        `).join('');
                    } else {
                        contentDiv.innerHTML = '<div class="text-gray-500 text-center py-4">未找到相关结果</div>';
                    }
                    
                    resultsDiv.classList.remove('hidden');
                }
            },
            
            // 清除搜索结果
            clearResults: function() {
                const resultsDiv = document.getElementById('search-results');
                const contentDiv = document.getElementById('search-results-content');
                
                if (resultsDiv) {
                    resultsDiv.classList.add('hidden');
                }
                if (contentDiv) {
                    contentDiv.innerHTML = '';
                }
            }
        };
        
        // 简化的搜索模态框打开函数
        function openSearchModal() {
            console.log('openSearchModal called'); // 调试日志
            const modal = document.getElementById('search-modal');
            const panel = document.getElementById('search-panel');
            
            if (modal && panel) {
                console.log('Opening search modal'); // 调试日志
                modal.classList.remove('hidden');
                // 延迟显示动画
                setTimeout(() => {
                    panel.classList.remove('translate-y-full');
                    // 聚焦到输入框
                    const input = document.getElementById('search-input');
                    if (input) {
                        input.focus();
                    }
                }, 10);
            } else {
                console.error('Search modal elements not found!');
            }
        }
        
        // 简化的搜索模态框关闭函数
        function closeSearchModal() {
            console.log('closeSearchModal called'); // 调试日志
            const modal = document.getElementById('search-modal');
            const panel = document.getElementById('search-panel');
            
            if (modal && panel) {
                panel.classList.add('translate-y-full');
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 300);
            }
        }
        
        // 切换搜索面板
        function toggleSearch() {
            if (SearchManager.isOpen) {
                SearchManager.close();
            } else {
                SearchManager.open();
            }
        }
        
        // 关闭搜索面板
        function closeSearch() {
            SearchManager.close();
        }
        
        // 执行搜索
        function performSearch() {
            const input = document.getElementById('search-input');
            const query = input ? input.value.trim() : '';
            
            if (query) {
                console.log('搜索关键词:', query);
                
                // 重定向到搜索结果页面
                window.location.href = '/search/results?query=' + encodeURIComponent(query);
            }
        }
        
        // 处理搜索建议点击
        function searchSuggestion(suggestion) {
            const input = document.getElementById('search-input');
            if (input) {
                input.value = suggestion;
                performSearch();
            }
        }
        
        // 处理回车键搜索
        function handleSearchKeypress(event) {
            if (event.key === 'Enter') {
                performSearch();
            }
        }
        
        // 打开搜索结果
        function openSearchResult(url) {
            window.location.href = url;
        }
        
        // 点击模态框背景关闭搜索面板
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('search-modal');
            // 如果点击的是模态框本身或背景遮罩层（不是搜索面板内部），则关闭
            if (event.target === modal || (event.target.classList && event.target.classList.contains('absolute') && event.target.parentElement === modal)) {
                closeSearchModal();
            }
        });
        
        // ESC键关闭搜索面板
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const modal = document.getElementById('search-modal');
                if (modal && !modal.classList.contains('hidden')) {
                    closeSearchModal();
                }
            }
        });
    </script>
    
    <!-- Like Button Component -->
    <script th:src="@{/js/like-button-component.js}"></script>
    
    <!-- 全局主题切换脚本 -->
    <div th:replace="~{fragments/footer :: theme-script}"></div>
    
</body>
</html>
